{% extends '::base.html.twig' %}

{% block javascripts_head %}
    {{ parent() }}

    <script src="{{ asset('bundles/app/vendor/d3/d3.js') }}"></script>
    <script src="{{ asset('bundles/app/vendor/d3-tip/index.js') }}"></script>

    <script src="{{ asset('bundles/app/vendor/nvd3/build/nv.d3.js') }}"></script>
    <link href="{{ asset('bundles/app/vendor/nvd3/build/nv.d3.css') }}" rel="stylesheet">

    <script>
        var journeymonitor = {
            'renderTestresults': function(testcaseId, testresults) {

                var getDate = function(index) {
                    return testresults[index].datetimeRun.date;
                };

                console.log(testresults[0]);

                var runtimeValues = testresults.map(function(testresult, index) {
                    return {'x': index, 'y': testresult.runtimeMilliseconds / 1000};
                });

                var numberOf200Values = testresults.map(function(testresult, index) {
                    return {'x': index, 'y': testresult.numberOf200};
                });

                var numberOf400Values = testresults.map(function(testresult, index) {
                    return {'x': index, 'y': testresult.numberOf400};
                });

                var numberOf500Values = testresults.map(function(testresult, index) {
                    return {'x': index, 'y': testresult.numberOf500};
                });

                var data = [
                    {'key': 'Runtime (s)', 'values': runtimeValues, 'nonStackable': true},
                    {'key': 'Status 200', 'values': numberOf200Values},
                    {'key': 'Status 400', 'values': numberOf400Values},
                    {'key': 'Status 500', 'values': numberOf500Values}
                ];

                nv.addGraph(function() {
                    var chart = nv.models.multiBarChart()
                      .duration(200)
                      .showControls(true)
                      .groupSpacing(0.0)
                      .stacked(true)
                    ;

                    chart.color(['#7777ff', '#5cb85c', 'orange', 'red']);

                    chart.xAxis
                        .tickFormat(function(index) { return getDate(index); });

                    chart.xAxis.fontSize('9px');

                    chart.yAxis
                        .tickFormat(d3.format(',.1'));

                    d3.select('#testcase-' + testcaseId + '-chart svg')
                        .datum(data)
                        .call(chart);

                    nv.utils.windowResize(chart.update);

                    return chart;
                });
            }
        };
    </script>

{% endblock %}

{% block body %}
    <main>
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <h4>Your testcases</h4>
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="panel panel-info">
                                <p class="panel-body">
                                    Hover over (on mobile: tap) each block in the timeline for
                                    access to the Selenium <b>logs</b>, web performance
                                    <b>metrics</b> (detailed waterfall for each page requested), and
                                    failure <b>screenshots</b>.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="pagenav">
                        <a class="pull-right" {% if (not isDemoMode) %} href="{{ path('testcases.new') }}" {% else %} data-toggle="tooltip" data-placement="top" title="Not available in demo mode" {% endif %}>ï¼‹ Add another testcase</a>
                    </div>

                    <table class="table testcases">
                        {{ include('AppBundle:testcases:_testcases-list.html.twig') }}
                    </table>
                </div>
            </div>
        </div>
    </main>

{% endblock %}

{% block javascripts_additional %}
{% endblock %}
